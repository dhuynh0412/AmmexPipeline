{
	"name": "IngestAdfLoadControlSourceSystemInformationSchema",
	"properties": {
		"activities": [
			{
				"name": "AdfLoadControlSourceSystemInformationSchema",
				"type": "Copy",
				"dependsOn": [],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "SqlServerSource",
						"sqlReaderQuery": {
							"value": "/**************************************************************************************\n* Name\t\t: AdfLoadControl_PopulateAmmex.SQL\n* Author\t: Duy Huynh\n* Date\t\t: 2022-05-19\n* Details\t: Collect the meatadata from source system for subject to build pipelines on to EDW.\n\t\t\t  The following script execute against the system\n\t\t\t\tServer: Denali\n\t\t\t\tDatabase: Ammex\n* DataBase\t: AmmexDataWarehouse\n* Schema\t: ETL\n**************************************************************************************/\n\nSELECT\tDISTINCT\n\t\t[ServerName] = QUOTENAME(@@SERVERNAME), \n\t\t[SourceSystem] = 'Ammex',\n\t\t[Table_Catalog] = QUOTENAME(T.TABLE_CATALOG),\n\t\t[Table_Schema] = QUOTENAME(T.TABLE_SCHEMA),\n\t\t[Table_Name] = QUOTENAME(T.TABLE_NAME),\n\t\t[Table_Type] = 'Table',\n\t\t[Column_Name] = QUOTENAME(C.COLUMN_NAME),\n\t\t[IsPrimaryKeyColumn] = CASE WHEN TC.CONSTRAINT_TYPE = 'PRIMARY KEY' AND CCU.COLUMN_NAME IS NOT NULL THEN 1  ELSE 0 END,\n\t\tC.[IS_NULLABLE],\n\t\tC.[Data_Type],\n\t\tC.[Numeric_Precision],\n\t\tC.[Numeric_Precision_Radix],\n\t\tC.[Character_Maximum_Length],\n\t\t[FormatDatatype] = CASE \n                                WHEN UPPER(C.DATA_TYPE) IN ('date', 'datetime', 'smalldatetime')                                     \n\t\t\t\t\t\t\t\t\tTHEN CONCAT(QUOTENAME(C.COLUMN_NAME), ' = CASE WHEN [SRC].', QUOTENAME(C.COLUMN_NAME), ' = ''NULL'' THEN NULL ELSE CONVERT(DATETIME2, [SRC].', QUOTENAME(C.COLUMN_NAME), ') END,')\n\t\t\t\t\t\t\t\tWHEN UPPER(C.DATA_TYPE) IN ('uniqueidentifier', 'bit', 'tinyint', 'int', 'bigint', 'float', 'money', 'real', 'smallint', 'binary')                                     \n\t\t\t\t\t\t\t\t\tTHEN CONCAT(QUOTENAME(C.COLUMN_NAME), ' = CONVERT(', QUOTENAME(UPPER(C.DATA_TYPE)), ', [SRC].', QUOTENAME(C.COLUMN_NAME), '),')\n                                WHEN UPPER(C.DATA_TYPE) IN ('numeric', 'decimal') \n                                    THEN CONCAT(QUOTENAME(C.COLUMN_NAME), ' = CONVERT(', QUOTENAME(UPPER(C.DATA_TYPE)), '(', C.NUMERIC_PRECISION, ', ', C.NUMERIC_PRECISION_RADIX, ')', ', [SRC].', QUOTENAME(C.COLUMN_NAME), '),')\t\t\t\t\t\t\t\t\t\t \n                                WHEN UPPER(C.DATA_TYPE) IN ('char', 'nvarchar', 'varchar', 'varbinary') \n                                    THEN CONCAT(QUOTENAME(C.COLUMN_NAME), ' = CONVERT(NVARCHAR(', C.CHARACTER_MAXIMUM_LENGTH, '), [SRC].', QUOTENAME(C.COLUMN_NAME), '),')\n                                ELSE quotename(C.COLUMN_NAME) + ','\n                            END,\n\t\t[UpdateStatement] = CASE WHEN C.COLUMN_NAME = 'LastUpdateDate' THEN '['+ C.COLUMN_NAME + '] = GETDATE()' ELSE '['+ C.COLUMN_NAME + '] = SRC.[' + C.COLUMN_NAME + '],' END,\n\t\t[View_Definition] = NULL,\n\t\t[LoadDate] = GETDATE(),\n\t\t[IsSourceDeleted] = CONVERT([BIT], 0),\n\t\t[IsSourceDeletedDate] = CONVERT([DATETIME2], NULL),\n\t\t[LastUpdatedDate] = CONVERT([DATETIME2], NULL)\nFROM INFORMATION_SCHEMA.TABLES T\n\t JOIN INFORMATION_SCHEMA.COLUMNS C\n\t\t  ON T.TABLE_NAME = C.TABLE_NAME\n\t LEFT JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS TC\n\t\t  ON T.TABLE_NAME = TC.TABLE_NAME\n\t\t\t AND TC.CONSTRAINT_TYPE = 'PRIMARY KEY'\n\t LEFT JOIN INFORMATION_SCHEMA.CONSTRAINT_COLUMN_USAGE CCU\n\t\t  ON CCU.CONSTRAINT_NAME = TC.CONSTRAINT_NAME  \n\t\t\t AND CCU.TABLE_NAME = T.TABLE_NAME\n\t\t\t AND CCU.COLUMN_NAME = C.COLUMN_NAME\nWHERE T.TABLE_TYPE = 'BASE TABLE'\nUNION\nSELECT\tDISTINCT\n\t\t[ServerName] = QUOTENAME(@@SERVERNAME), \n\t\t[SourceSystem] = 'Ammex',\n\t\t[Table_Catalog] = QUOTENAME(V.[TABLE_CATALOG]),\n\t\t[Table_Schema] = QUOTENAME(V.[TABLE_SCHEMA]),\n\t\t[Table_Name] = QUOTENAME(V.[TABLE_NAME]),\n\t\t[IS_NULLABLE] = 'NO',\n\t\t[Table_Type] = 'View',\n\t\t[Column_Name] = NULL,\n\t\t[IsPrimaryKeyColumn] = NULL,\n\t\t[Data_Type] = NULL,\n\t\t[Numeric_Precision] = NULL,\n\t\t[Numeric_Precision_Radix] = NULL,\n\t\t[Character_Maximum_Length] = NULL,\n\t\t[FormatDatatype] = NULL,\n\t\t[UpdateStatement] = NULL,\n\t\t[View_Definition] = V.[VIEW_DEFINITION],\n\t\t[LoadDate] = GETDATE(),\n\t\t[IsSourceDeleted] = CONVERT([BIT], 0),\n\t\t[IsSourceDeletedDate] = CONVERT([DATETIME2], NULL),\n\t\t[LastUpdatedDate] = CONVERT([DATETIME2], NULL)\nFROM INFORMATION_SCHEMA.VIEWS V",
							"type": "Expression"
						},
						"queryTimeout": "02:00:00",
						"partitionOption": "None"
					},
					"sink": {
						"type": "SqlDWSink",
						"preCopyScript": {
							"value": "IF OBJECT_ID('[Loader].[AdfLoadControlSourceSystemInformationSchema]') IS NOT NULL    DROP TABLE [Loader].[AdfLoadControlSourceSystemInformationSchema];",
							"type": "Expression"
						},
						"writeBehavior": "Insert",
						"sqlWriterUseTableLock": false,
						"tableOption": "autoCreate",
						"disableMetricsCollection": false
					},
					"enableStaging": false,
					"translator": {
						"type": "TabularTranslator",
						"typeConversion": true,
						"typeConversionSettings": {
							"allowDataTruncation": true,
							"treatBooleanAsNumber": false
						}
					}
				},
				"inputs": [
					{
						"referenceName": "DsSqlDenaliAmmex_EdwAdfPipelineReadOnly",
						"type": "DatasetReference"
					}
				],
				"outputs": [
					{
						"referenceName": "DsAsaAmmexEdw_EdwAdfPipelineWrite",
						"type": "DatasetReference",
						"parameters": {
							"Schema": "Loader",
							"Table": "AdfLoadControlSourceSystemInformationSchema"
						}
					}
				]
			},
			{
				"name": "Execute Proc ETL AdfLoadControlInboundMetadata_Populate",
				"type": "Script",
				"dependsOn": [
					{
						"activity": "AdfLoadControlSourceSystemInformationSchema",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "LsAsaAmmexEdw_EdwAdfPipelineWrite",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "Query",
							"text": {
								"value": "EXEC [ETL].[AdfLoadControlInboundMetadata_Populate]",
								"type": "Expression"
							}
						}
					]
				}
			}
		],
		"folder": {
			"name": "1-Ingest"
		},
		"annotations": []
	}
}